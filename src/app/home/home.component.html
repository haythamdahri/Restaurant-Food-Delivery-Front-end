<!-- Header -->
<div class="row">
  <app-header class="nopadding col-12"></app-header>
</div>

<div class="row">
  <!-- Left sidebar -->
  <div class="col-sm-12 col-md-12 col-lg-3 col-xl-3">
    <app-left-sidebar
      (addMealToCartEvent)="onAddMealOrder($event)"
    ></app-left-sidebar>
  </div>

  <!-- Meals -->
  <div class="col-sm-12 col-md-12 col-lg-9 col-xl-9">
    <!-- Add new meal icon -->
    <div
      class="col-12 mt-2 font-weight-bold"
      *ngIf="authService.isAuthenticated() && authService.isAdmin()"
    >
      <button
        (click)="initForm()"
        class="btn btn-warning btn-sm btn-block w-25 mx-auto"
        data-toggle="modal"
        data-target="#meal-form-modal"
      >
        <i class="fas fa-plus-circle"></i> Add new meal
      </button>
    </div>

    <!-- Laoding icon -->
    <div
      class="col-12 mx-auto mt-5 text-center"
      *ngIf="!errorMode && loadingMode"
    >
      <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <!-- No meals found message -->
    <div
      class="col-12 mx-auto mt-5"
      *ngIf="!errorMode && !loadingMode && page && page?.content?.length == 0"
    >
      <div
        class="shadow-sm p-3 bg-white rounded text-center font-weight-bold text-primary"
      >
        <i class="fas fa-exclamation"></i> No meals to shop
      </div>
    </div>

    <!-- Error mode message -->
    <div class="col-12 mx-auto mt-5" *ngIf="errorMode">
      <div class="shadow p-3 mb-5 rounded bg-danger text-white text-center">
        <i class="fas fa-exclamation"></i> An error occurred, please try again
        later!
      </div>
    </div>

    <div class="row">
      <!-- Loop over meals retrieved from server -->
      <div
        class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mx-auto mt-3 d-flex align-items-stretch"
        *ngFor="let meal of page?.content"
      >
        <div
          class="card shadow p-3 mb-5 bg-white rounded"
          style="padding: 2rem;"
        >
          <button
            class="btn btn-debug btn-sm btn-block text-center"
            (click)="onMealFetch(meal.id)"
            *ngIf="authService.isAuthenticated() && authService.isAdmin()"
          >
            <i class="fas fa-edit"></i>
          </button>
          <img
            [src]="meal.image"
            class="card-img-top shadow-sm rounded myImg img-fluid"
            alt="{{ meal.name }}"
          />
          <div class="card-body">
            <h5 class="card-title font-weight-bold">{{ meal.name }}</h5>
            <!-- Check sale price -->
            <p class="card-text" *ngIf="meal.salePrice == null">
              {{ meal.price }} Dhs
            </p>
            <ng-container class="card-text" *ngIf="meal.salePrice != null">
              <p>
                {{ meal.salePrice }} Dhs
                <i class="text-danger"
                  ><del>{{ meal.price }} Dhs</del></i
                >
              </p>
            </ng-container>
            <!-- Views -->
            <p>{{ meal.views }} <i class="fas fa-eye"></i></p>
            <!-- Meal action buttons -->
            <div class="row">
              <div class="col-sm-12 col-md-6 col-lg-6 col-xl-6 text-center">
                <button
                  class="btn btn-outline-primary shadow-lg"
                  (click)="onAddMealOrder(meal)"
                >
                  <i class="fas fa-cart-plus"></i> Add To Cart
                </button>
              </div>
              <div class="col-sm-12 col-md-6 col-lg-6 col-xl-6 text-center">
                <button
                  id="btnPreffer{{ meal.id }}"
                  (click)="onMealPreference($event, meal.id)"
                  class="btn"
                  style="background-color: transparent;"
                >
                  <i
                    class="fas fa-heart"
                    *ngIf="checkMealPreferred(meal.id) === true"
                  ></i>
                  <i
                    class="far fa-heart"
                    *ngIf="checkMealPreferred(meal.id) === false"
                  ></i>
                </button>
              </div>
            </div>
            <!-- Meal rating -->
            <div class="row">
              <div
                class="col-sm-12 col-md-12 col-lg-12 col-xl-12 text-center text-warning" 
              >
                <!-- Stared reviews -->
                <ng-container *ngFor="let rate of mealService.getRating(meal.reviews).filledStars">
                  <i class="fas fa-star"></i>
                </ng-container>
                <!-- Remaining non stared reviews -->
                <ng-container *ngFor="let rate of mealService.getRating(meal.reviews).unfilledStars">
                  <i class="far fa-star"></i>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <hr class="my-no w-100" />
        <app-custom-pagination
          [page]="page"
          [loading]="loadingMode"
          (nextPageEvent)="getNextPage()"
          (previousPageEvent)="getPreviousPage()"
          (pageSizeEvent)="getPageInNewSize($event)"
        >
        </app-custom-pagination>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div
    class="modal fade"
    id="meal-form-modal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="myExtraLargeModalLabel"
    aria-hidden="true"
    *ngIf="authService.isAuthenticated() && authService.isAdmin()"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Meal Form</h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form [formGroup]="form" (ngSubmit)="onSaveMeal()">
          <div class="modal-body">
            <div class="form-group">
              <label for="Name">Name</label>
              <input
                type="text"
                class="form-control"
                [ngClass]="{
                  'is-invalid':
                    form.controls.name.touched && form.controls.name.invalid,
                  'is-valid':
                    form.controls.name.touched && form.controls.name.valid
                }"
                id="Name"
                placeholder="Meal name"
                formControlName="name"
              />
              <div
                class="invalid-feedback"
                *ngIf="form.controls.name.touched && form.controls.name.invalid"
              >
                Invalid meal name
              </div>
            </div>
            <div class="form-group">
              <label for="Image">Image Url</label>
              <input
                type="url"
                class="form-control"
                id="Image"
                [ngClass]="{
                  'is-invalid':
                    form.controls.image.touched && form.controls.image.invalid,
                  'is-valid':
                    form.controls.image.touched && form.controls.image.valid
                }"
                placeholder="Meal image url"
                formControlName="image"
              />
              <div
                class="invalid-feedback"
                *ngIf="
                  form.controls.image.touched && form.controls.image.invalid
                "
              >
                Invalid meal image
              </div>
            </div>
            <div class="form-group">
              <label for="Price">Price</label>
              <input
                type="number"
                class="form-control"
                id="Price"
                [ngClass]="{
                  'is-invalid':
                    form.controls.price.touched && form.controls.price.invalid,
                  'is-valid':
                    form.controls.price.touched && form.controls.price.valid
                }"
                placeholder="Meal price"
                formControlName="price"
              />
              <div
                class="invalid-feedback"
                *ngIf="
                  form.controls.price.touched && form.controls.price.invalid
                "
              >
                Invalid meal price
              </div>
            </div>
            <div class="form-group">
              <label for="Stock">Available Stock</label>
              <input
                type="number"
                class="form-control"
                [ngClass]="{
                  'is-invalid':
                    form.controls.stock.touched && form.controls.stock.invalid,
                  'is-valid':
                    form.controls.stock.touched && form.controls.stock.valid
                }"
                id="Stock"
                placeholder="Meal available stock"
                formControlName="stock"
              />
              <div
                class="invalid-feedback"
                *ngIf="
                  form.controls.stock.touched && form.controls.stock.invalid
                "
              >
                Invalid meal stock
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary btn-sm"
              #closeBtn
              data-dismiss="modal"
            >
              <i class="far fa-times-circle"></i> Close
            </button>
            <button
              type="submit"
              class="btn btn-success btn-sm"
              [disabled]="form.invalid"
              #saveMealnBtn
            >
              <i class="fas fa-save"></i> Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
